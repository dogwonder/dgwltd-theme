---
permalink: '../../../../sw.js'
---

const cacheName = 'dgwltd:{% pkgVersion %}';
const themePath = '/wp-content/themes/dgwltd-theme';
const offlineUrl = `${themePath}/dist/offline.html`;
const cacheFiles = [
  offlineUrl,
  `${themePath}/dist/css/main.css`,
  `${themePath}/dist/js/app.min.js`,
  `${themePath}/dist/js/govuk-frontend-5.11.0.min.js`,
  `${themePath}/dist/icons/fav/favicon.png`,
  `${themePath}/dist/icons/fav/favicon-192x192.png`,
  `${themePath}/dist/fonts/soehne/soehne-halbfett.woff2`,
  `${themePath}/dist/fonts/soehne/soehne-dreiviertelfett.woff2`,
  `${themePath}/dist/fonts/soehne/soehne-kraftig.woff2`
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(cacheName).then(async cache => {
      for (const url of cacheFiles) {
        try {
          await cache.add(url);
        } catch (err) {
          // Ignore individual failures so install isn't blocked.
        }
      }
    })
  );
});

self.addEventListener('fetch', event => {
  if (
    event.request.method !== 'GET' ||
    event.request.mode !== 'navigate' ||
    /\/wp-admin\//.test(event.request.url) ||
    event.request.url.includes('preview=true')
  ) {
    return;
  }

  event.respondWith(
    fetch(event.request).catch(async () => {
      const cache = await caches.open(cacheName);
      const cachedOffline = await cache.match(offlineUrl);
      if (cachedOffline) {
        return cachedOffline;
      }
      return Response.error();
    })
  );
});

self.addEventListener('activate', event => {
  event.waitUntil(
    (async () => {
      const keys = await caches.keys();
      await Promise.all(
        keys.map(key => {
          if (key !== cacheName) {
            return caches.delete(key);
          }
        })
      );
      await self.clients.claim();
    })()
  );
});
